<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>mood</title>
        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Saira:wght@200;400&display=swap" rel="stylesheet">
    
        <style>
            :root {
                --bg-color: #1a1a1a;
                --primary-color: #2c3e50;
                --secondary-color: #34495e;
                --accent-color: #008080;
                --accent-secondary-color: #009e9e;
                --text-color: #ecf0f1;
                --shadow-color: rgba(0, 0, 0, 0.5);
            }
        
            body {
                font-family: 'Saira', sans-serif;
                font-weight: 200;
                text-transform: uppercase;
                background-color: var(--bg-color);
                color: var(--text-color);
                margin: 0;
                padding: 2rem;
                text-align: center;
            }
        
            /* MODIFIED: Converted to flexbox for button alignment */
            h1 {
                color: var(--accent-color);
                font-weight: 200;
                letter-spacing: 4px;
                font-size: 3em;
                display: flex;
                justify-content: center;
                align-items: center;
                position: relative; /* Needed for absolute positioning of the button */
            }
        
            /* NEW: Styles for the sleep timer button */
            #sleepTimerButton {
                font-family: 'Saira', sans-serif;
                font-weight: 400;
                text-transform: uppercase;
                letter-spacing: 1px;
                font-size: 0.4em; /* Relative to the h1 font size */
                background-color: transparent;
                border: 2px solid var(--secondary-color);
                color: var(--secondary-color);
                border-radius: 50px;
                padding: 0.5em 1em;
                cursor: pointer;
                transition: all 0.3s ease;
                position: absolute; /* Position it on the right */
                right: 0;
            }
        
            #sleepTimerButton:hover {
                border-color: var(--accent-color);
                color: var(--accent-color);
            }
        
            /* NEW: Style for when the timer is active */
            #sleepTimerButton.active {
                border-color: var(--accent-color);
                color: var(--bg-color);
                background-color: var(--accent-color);
                cursor: default;
            }
        
        
            #soundboard {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1.5rem;
                text-transform: uppercase;
                max-width: 1600px; 
                margin: 2rem auto;
            }
        
            .track-button {
                background-color: var(--primary-color);
                border: 2px solid var(--secondary-color);
                color: var(--text-color);
                padding: 1.5rem 1rem;
                cursor: pointer;
                border-radius: 50px; 
                font-size: 1rem;
                font-weight: 400;
                letter-spacing: 1px;
                transition: all 0.3s ease;
                box-shadow: 0 4px 8px var(--shadow-color);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        
            .track-button:hover:not(:disabled):not(.active) {
                background-color: var(--secondary-color);
                transform: translateY(-3px);
                box-shadow: 0 6px 12px var(--shadow-color);
            }
        
            .track-button.active {
                background-color: var(--accent-color);
                color: var(--bg-color);
                font-weight: 400;
                box-shadow: 0 0 15px var(--accent-color);
                border-color: var(--accent-color);
            }
        
            .track-button.active:hover {
                background-color: var(--accent-secondary-color);
                transform: translateY(-3px);
            }
            
            .track-button:disabled {
                cursor: not-allowed;
                background-color: transparent;
                border: 2px dashed var(--accent-color);
                color: var(--accent-color);
                opacity: 0.7;
                transform: none;
                box-shadow: none;
            }
        </style>
    </head>
<body>

    <h1>
        mood
        <button id="sleepTimerButton">30 MIN SLEEP</button>
    </h1>
    <div id="soundboard">
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const soundboard = document.getElementById('soundboard');
                const sleepTimerButton = document.getElementById('sleepTimerButton'); // NEW
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const activeTracks = {};
        
                let sleepTimer = null; // NEW: To hold the timer ID
        
                const repoOwner = 'haamukahvi';
                const repoName = 'mood';
                const tracksPath = 'tracks';
                
                const FADE_DURATION = 3; 
        
                // NEW: Function to start the sleep timer
                function startSleepTimer() {
                    if (sleepTimer) {
                        // Timer is already running, do nothing
                        return;
                    }
        
                    sleepTimerButton.classList.add('active');
                    sleepTimerButton.disabled = true;
        
                    const thirtyMinutes = 30 * 60 * 1000;
                    sleepTimer = setTimeout(() => {
                        fadeOutAllTracks();
                        sleepTimerButton.classList.remove('active');
                        sleepTimerButton.disabled = false;
                        sleepTimer = null; // Reset the timer
                    }, thirtyMinutes);
                }
        
                // NEW: Function to fade out all currently playing tracks
                function fadeOutAllTracks() {
                    const FADEOUT_DURATION = 60; // 1 minute fade-out
                    for (const url in activeTracks) {
                        const track = activeTracks[url];
                        
                        // Set current volume and then ramp down
                        track.gainNode.gain.setValueAtTime(track.gainNode.gain.value, audioContext.currentTime);
                        track.gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + FADEOUT_DURATION);
        
                        // Clean up after the fade is complete
                        setTimeout(() => {
                            track.audio.pause();
                            track.source.disconnect();
                            track.button.classList.remove('active');
                            delete activeTracks[url];
                        }, FADEOUT_DURATION * 1000);
                    }
                }
        
                async function getTrackList() {
                    const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${tracksPath}`;
                    try {
                        const response = await fetch(apiUrl);
                        const data = await response.json();
                        return data
                            .filter(file => file.type === 'file' && /\.(mp3|ogg|wav)$/i.test(file.name))
                            .map(file => file.download_url);
                    } catch (error) {
                        console.error('Error fetching track list:', error);
                        soundboard.innerHTML = `<p style="color: #e74c3c;">Failed to load tracks from GitHub. Please check the repository path and make sure it's public.</p>`;
                        return [];
                    }
                }
        
                function createTrackButton(url) {
                    const fileName = decodeURIComponent(url.split('/').pop().replace(/\.\w+$/, ''));
                    const button = document.createElement('button');
                    button.className = 'track-button';
                    button.textContent = fileName.replace(/_/g, ' ');
                    button.dataset.url = url;
        
                    button.addEventListener('click', () => {
                        if (audioContext.state === 'suspended') {
                            audioContext.resume();
                        }
        
                        if (activeTracks[url]) {
                            stopTrack(url);
                        } else {
                            playTrack(url, button);
                        }
                    });
        
                    soundboard.appendChild(button);
                }
        
                async function playTrack(url, button) {
                    button.disabled = true;
        
                    const audio = new Audio(url);
                    audio.crossOrigin = "anonymous";
                    audio.loop = true;
        
                    const source = audioContext.createMediaElementSource(audio);
                    const gainNode = audioContext.createGain();
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        
                    source.connect(gainNode);
                    gainNode.connect(audioContext.destination);
        
                    try {
                        await audio.play();
                        
                        gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + FADE_DURATION);
        
                        activeTracks[url] = { audio, source, gainNode, button };
                        button.classList.add('active');
        
                        setTimeout(() => {
                            if (activeTracks[url]) {
                                button.disabled = false;
                            }
                        }, FADE_DURATION * 1000);
        
                    } catch (err) {
                        console.error("Playback failed:", err);
                        button.disabled = false; 
                    }
                }
        
                function stopTrack(url) {
                    const track = activeTracks[url];
                    if (!track) return;
        
                    track.button.disabled = true;
                    track.button.classList.remove('active');
        
                    track.gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + FADE_DURATION);
                    
                    setTimeout(() => {
                        track.audio.pause();
                        track.source.disconnect();
                        
                        delete activeTracks[url];
                        
                        track.button.disabled = false; 
                    }, FADE_DURATION * 1000);
                }
        
                async function init() {
                    // NEW: Add event listener to the timer button
                    sleepTimerButton.addEventListener('click', startSleepTimer);
        
                    const trackUrls = await getTrackList();
                    if (trackUrls.length > 0) {
                        trackUrls.forEach(createTrackButton);
                    } else if (!soundboard.innerHTML) {
                         soundboard.innerHTML = `<p>No audio tracks found in the specified folder.</p>`;
                    }
                }
        
                init();
            });
        </script>

</body>
</html>